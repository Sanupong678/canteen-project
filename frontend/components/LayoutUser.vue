<template>
  <div class="user-layout">
    <!-- Navbar ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1 -->
    <nav class="navbar-top">
      <div class="navbar-container grid navbar-top-container">
        <div class="brand area-left">
          <div class="logo">
            <img src="/images/Logo.jpg" alt="Logo">
          </div>
          <div class="navbar-title">
            <h1 class="navbar-title-text">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡πÄ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á</h1>
            <p class="navbar-subtitle-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
          </div>
        </div>
        <div class="user-actions area-right">
          <NotificationDropdown />
          <div class="user-profile" @click="toggleUserMenu">
            <div class="avatar">{{ userInitials }}</div>
            <span class="username">{{ displayName }}</span>
            <span class="caret">‚ñæ</span>
            <div class="user-menu" v-if="showUserMenu">
              <div class="menu-item" @click="openChangePasswordModal">
                <i class="fas fa-key menu-icon"></i>
                <span class="menu-text">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</span>
              </div>
              <div class="menu-item" @click="openDetailsModal">
                <i class="fas fa-info-circle menu-icon"></i>
                <span class="menu-text">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
              </div>
              <div class="menu-divider"></div>
              <div class="menu-item logout-item" @click="handleLogout">
                <i class="fas fa-sign-out-alt menu-icon"></i>
                <span class="menu-text">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Navbar ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2 -->
    <nav class="navbar-bottom">
      <div class="navbar-container">
        <ul class="nav-list">
          <li><router-link to="/user" class="nav-link" active-class="active">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</router-link></li>
          <li><router-link to="/user/ranking" class="nav-link" active-class="active">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</router-link></li>
          <li><router-link to="/user/repair" class="nav-link" active-class="active">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</router-link></li>
          <li><router-link to="/user/leave" class="nav-link" active-class="active">‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤</router-link></li>
          <li><router-link to="/user/bill" class="nav-link" active-class="active">‡∏ö‡∏¥‡∏•</router-link></li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="user-main">
      <slot></slot>
    </main>

    <!-- Footer -->
    <footer class="user-footer">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-title">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</h3>
          <div class="contact-info">
            <div class="contact-item">
              <i class="fas fa-building"></i>
              <span>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á (Mfu Food Court)</span>
            </div>
            <div class="contact-item">
              <i class="fas fa-map-marker-alt"></i>
              <span>Chiang Rai, Thailand, Chiang Rai</span>
            </div>
            <div class="contact-item">
              <i class="fas fa-phone"></i>
              <span>053 917 144</span>
            </div>
          </div>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
          <div class="social-links">
            <a href="https://asset.mfu.ac.th/asset-home.html" 
               class="social-link" 
               title="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ"
               target="_blank">
              <i class="fas fa-university"></i>
              <span>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
            </a>
            <a href="https://www.facebook.com/MFUFOODCOURT" 
               class="social-link facebook" 
               target="_blank">
              <i class="fab fa-facebook-f"></i>
              <span>Facebook</span>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Change Password Modal -->
    <div v-if="showChangePasswordModal" class="password-modal" @click="closeChangePasswordModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
          <button class="modal-close-btn" @click="closeChangePasswordModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="credentials-section">
            <div class="shop-info-header">
              <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
              <p class="shop-name">{{ shopData.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
            </div>
            <div class="credentials-info">
              <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
              <div class="credential-item">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                <span>{{ shopData.credentials?.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
              </div>
              <div class="credential-item">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
                <div class="current-password-wrapper">
                  <span v-if="shopData.credentials?.password">
                    {{ showCurrentPassword ? shopData.credentials.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' }}
                  </span>
                  <span v-else>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                  <button 
                    v-if="shopData.credentials?.password"
                    type="button" 
                    class="password-toggle-btn current-password-toggle" 
                    @click="toggleCurrentPassword"
                    :title="showCurrentPassword ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'"
                  >
                    <i :class="showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="password-section">
              <h4>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
              <div class="form-group">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
                <div class="password-input-wrapper">
                  <input 
                    :type="showNewPassword ? 'text' : 'password'" 
                    v-model="passwordForm.newPassword" 
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"
                    :class="{ 'error': passwordError }"
                  >
                  <button 
                    type="button" 
                    class="password-toggle-btn" 
                    @click="toggleNewPassword"
                    :title="showNewPassword ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'"
                  >
                    <i :class="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                  </button>
                </div>
                <small class="error-message" v-if="passwordError">{{ passwordError }}</small>
              </div>
              <div class="form-group">
                <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                <div class="password-input-wrapper">
                  <input 
                    :type="showConfirmPassword ? 'text' : 'password'" 
                    v-model="passwordForm.confirmPassword" 
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
                    :class="{ 'error': confirmPasswordError }"
                  >
                  <button 
                    type="button" 
                    class="password-toggle-btn" 
                    @click="toggleConfirmPassword"
                    :title="showConfirmPassword ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'"
                  >
                    <i :class="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                  </button>
                </div>
                <small class="error-message" v-if="confirmPasswordError">{{ confirmPasswordError }}</small>
              </div>
              <div class="password-requirements">
                <p>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ:</p>
                <ul>
                  <li :class="{ 'met': passwordForm.newPassword.length >= 8 }">‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</li>
                  <li :class="{ 'met': /[A-Z]/.test(passwordForm.newPassword) }">‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà 1 ‡∏ï‡∏±‡∏ß</li>
                  <li :class="{ 'met': /[a-z]/.test(passwordForm.newPassword) }">‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å 1 ‡∏ï‡∏±‡∏ß</li>
                  <li :class="{ 'met': /[0-9]/.test(passwordForm.newPassword) }">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1 ‡∏ï‡∏±‡∏ß</li>
                </ul>
              </div>
              <div class="form-actions">
                <button class="cancel-btn" @click="closeChangePasswordModal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="save-btn" @click="handleChangePassword" :disabled="!isPasswordValid">
                  <i class="fas fa-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Modal -->
    <div v-if="showDetailsModal" class="modal-overlay" @click="closeDetailsModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
          <button class="close-btn" @click="closeDetailsModal">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="shop-image-container">
            <img :src="getFullImageUrl(shopData.image)" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="shop-image">
          </div>
          <div class="shop-info">
            <div class="detail-item">
              <label>‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô:</label>
              <span>{{ shopData.customId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</label>
              <span>{{ shopData.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
              <span>{{ getShopTypeLabel(shopData.type) }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</label>
              <span>{{ shopData.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
              <span>{{ getDescription(shopData.description) }}</span>
            </div>
            <div class="detail-item">
              <label>‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</label>
              <span>{{ getCanteenName(shopData.canteenId) }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
              <span>{{ formatDate(shopData.contractStartDate) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
              <span class="detail-value">{{ formatDate(shopData.contractEndDate) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
            </div>
            <div class="detail-item">
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</label>
              <span :class="{ 'expired': isExpired(shopData) }">
                <i :class="isExpired(shopData) ? 'fas fa-exclamation-circle' : 'fas fa-check-circle'"></i>
                {{ isExpired(shopData) ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏°‡∏µ‡∏ú‡∏•' }}
              </span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="close-btn" @click="closeDetailsModal">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import NotificationDropdown from './NotificationDropdown.vue'

export default {
  name: 'LayoutUser',
  components: {
    NotificationDropdown
  },
  data() {
    return {
      showUserMenu: false,
      displayName: 'User Name',
      shopData: {},
      userId: null,
      showChangePasswordModal: false,
      showDetailsModal: false,
      passwordForm: {
        newPassword: '',
        confirmPassword: ''
      },
      passwordError: '',
      confirmPasswordError: '',
      showNewPassword: false,
      showConfirmPassword: false,
      showCurrentPassword: false
    }
  },
  async mounted() {
    // Check if we're on the client side
    if (process.client) {
      // Set data from sessionStorage only on client side
      this.displayName = sessionStorage.getItem('displayName') || 'User Name'
      this.shopData = JSON.parse(sessionStorage.getItem('shopData') || '{}')
      this.userId = sessionStorage.getItem('userId')
      
      // Debug sessionStorage data
      console.log('üîç sessionStorage data:', {
        displayName: this.displayName,
        userId: this.userId,
        shopData: this.shopData,
        rawShopData: sessionStorage.getItem('shopData'),
        token: sessionStorage.getItem('token') ? sessionStorage.getItem('token').substring(0, 20) + '...' : 'missing',
        isAuthenticated: sessionStorage.getItem('isAuthenticated'),
        userRole: sessionStorage.getItem('userRole')
      })
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication
      const isAuthenticated = sessionStorage.getItem('isAuthenticated')
      const token = sessionStorage.getItem('token')
      
      if (!isAuthenticated || !token) {
        console.log('‚ùå User not authenticated, redirecting to login')
        this.$router.push('/login')
        return
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role
      const userRole = sessionStorage.getItem('userRole')
      if (userRole !== 'user') {
        console.log('‚ùå User role is not user, redirecting to login')
        this.$router.push('/login')
        return
      }
      
      console.log('‚úÖ User authenticated successfully')
      console.log('üë§ User data:', {
        displayName: this.displayName,
        userId: this.userId,
        shopData: this.shopData
      })
      
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
      await this.fetchShopDetails()
      
      // Initialize notifications ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      try {
        console.log('üîÑ Initializing notifications in LayoutUser...')
        await this.$initializeNotifications()
        console.log('‚úÖ Notifications initialized successfully')
      } catch (error) {
        console.error('‚ùå Error initializing notifications:', error)
      }
    }
  },
  methods: {
    toggleUserMenu() {
      this.showUserMenu = !this.showUserMenu
    },
    handleLogout() {
      if (process.client) {
        // Clear all session data
        sessionStorage.clear()
        
        // Clear cookies
        document.cookie = 'user_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
        document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
        
        console.log('‚úÖ Logged out successfully, cleared session data')
      }
      this.$router.push('/login')
    },
    openChangePasswordModal() {
      this.showChangePasswordModal = true
      this.showUserMenu = false
    },
    closeChangePasswordModal() {
      this.showChangePasswordModal = false
      this.passwordForm = {
        newPassword: '',
        confirmPassword: ''
      }
      this.passwordError = ''
      this.confirmPasswordError = ''
      this.showNewPassword = false
      this.showConfirmPassword = false
      this.showCurrentPassword = false
    },
    openDetailsModal() {
      this.showDetailsModal = true
      this.showUserMenu = false
    },
    closeDetailsModal() {
      this.showDetailsModal = false
    },
    getShopTypeLabel(type) {
      const types = {
        food: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
        beverage: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',
        other: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      }
      return types[type] || type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    },
    getFullImageUrl(imagePath) {
      if (!imagePath) return '/images/default-shop.jpg'
      if (imagePath.startsWith('http')) return imagePath
      return `${process.env.NODE_ENV === 'production' ? '' : 'http://localhost:4000'}${imagePath}`
    },
    getCanteenName(canteenId) {
      const canteens = {
        1: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 1',
        2: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 2',
        3: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 3',
        4: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 4',
        5: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 5'
      }
      return canteens[canteenId] || `‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${canteenId}` || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    },
    formatDate(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    },
    isExpired(shop) {
      if (!shop || !shop.contractEndDate) return false
      const endDate = new Date(shop.contractEndDate)
      const today = new Date()
      return endDate < today
    },
    getDescription(description) {
      if (!description || description === null || description === undefined) {
        return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
      }
      const trimmed = description.toString().trim()
      return trimmed === '' ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' : trimmed
    },
    validatePassword() {
      this.passwordError = ''
      this.confirmPasswordError = ''

      if (!this.passwordForm.newPassword) {
        this.passwordError = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'
        return false
      }

      if (this.passwordForm.newPassword.length < 8) {
        this.passwordError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'
        return false
      }

      if (!/[A-Z]/.test(this.passwordForm.newPassword)) {
        this.passwordError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà 1 ‡∏ï‡∏±‡∏ß'
        return false
      }

      if (!/[a-z]/.test(this.passwordForm.newPassword)) {
        this.passwordError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å 1 ‡∏ï‡∏±‡∏ß'
        return false
      }

      if (!/[0-9]/.test(this.passwordForm.newPassword)) {
        this.passwordError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1 ‡∏ï‡∏±‡∏ß'
        return false
      }

      if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
        this.confirmPasswordError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'
        return false
      }

      return true
    },
    async fetchShopDetails() {
      try {
        // ‡∏î‡∏∂‡∏á shopId ‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ shopData
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user, userId ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô shop._id
        const shopId = this.userId || this.shopData._id || this.shopData.id
        
        console.log('üîç Debug shopId lookup:', {
          'this.shopData._id': this.shopData._id,
          'this.shopData.id': this.shopData.id,
          'this.userId': this.userId,
          'final shopId': shopId
        })
        
        if (!shopId) {
          console.log('‚ùå No shopId found')
          console.log('‚ùå Available data:', {
            shopData: this.shopData,
            userId: this.userId
          })
          console.log('‚ùå sessionStorage data:', {
            userId: sessionStorage.getItem('userId'),
            shopData: sessionStorage.getItem('shopData'),
            displayName: sessionStorage.getItem('displayName'),
            userRole: sessionStorage.getItem('userRole')
          })
          return
        }
        
        console.log('üîç Fetching shop details for shopId:', shopId)
        
        const response = await this.$axios.get(`/api/shops/details/${shopId}`)
        
        if (response.data.success) {
          this.shopData = response.data.data
          console.log('‚úÖ Shop details fetched successfully:', this.shopData)
          console.log('üîç Description value:', this.shopData.description)
          console.log('üîç Description type:', typeof this.shopData.description)
        }
      } catch (error) {
        console.error('‚ùå Error fetching shop details:', error)
      }
    },
    async handleChangePassword() {
      if (this.validatePassword()) {
        try {
          const shopId = this.shopData._id || this.shopData.id
          
          if (!shopId) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤')
            return
          }
          
          console.log('Changing password for shop:', shopId)
          console.log('New password:', this.passwordForm.newPassword)
          
          const response = await this.$axios.put(`/api/shops/update-password/${shopId}`, {
            newPassword: this.passwordForm.newPassword
          })
          
          if (response.data.success) {
            alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
            this.closeChangePasswordModal()
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï credentials
            await this.fetchShopDetails()
          } else {
            alert(response.data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ')
          }
        } catch (error) {
          console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:', error)
          const errorMessage = error.response?.data?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
          alert(errorMessage)
        }
      }
    }
  },
  computed: {
    shopName() {
      return this.shopData.name || ''
    },
    shopType() {
      return this.shopData.type || ''
    },
    shopLocation() {
      return this.shopData.location || ''
    },
    userInitials() {
      if (this.displayName && this.displayName !== 'User Name') {
        return this.displayName.charAt(0).toUpperCase()
      }
      return 'U'
    },
    toggleNewPassword() {
      this.showNewPassword = !this.showNewPassword
    },
    toggleConfirmPassword() {
      this.showConfirmPassword = !this.showConfirmPassword
    },
    toggleCurrentPassword() {
      this.showCurrentPassword = !this.showCurrentPassword
    },
    isPasswordValid() {
      return (
        this.passwordForm.newPassword &&
        this.passwordForm.confirmPassword &&
        this.passwordForm.newPassword === this.passwordForm.confirmPassword &&
        this.passwordForm.newPassword.length >= 8 &&
        /[A-Z]/.test(this.passwordForm.newPassword) &&
        /[a-z]/.test(this.passwordForm.newPassword) &&
        /[0-9]/.test(this.passwordForm.newPassword) &&
        !this.passwordError &&
        !this.confirmPasswordError
      )
    }
  }
}
</script>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Inter:wght@400;600;700&display=swap');
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');
.user-layout {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Navbar ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1 */
.navbar-top {
  background-color: white;
  padding: 6px 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.navbar-top-container {
  max-width: none;
  margin: 0;
  padding: 0 35px;
}

.navbar-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Make top and bottom nav stretch edge-to-edge */
.navbar-top .navbar-container {
  max-width: none;
  margin: 0;
  padding: 0 35px;
}

.navbar-container.grid {
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
}

.area-left { justify-self: start; }
.area-right { justify-self: end; }

.brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo img { height: 72px; }

.navbar-title {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  text-align: left;
  gap: 2px;
}

.navbar-title-text {
  margin: 0;
  font-size: 26px;
  font-weight: 800;
  color: #111827;
  font-family: 'Kanit', 'Noto Sans Thai', sans-serif;
  line-height: 1.1;
}

.navbar-subtitle-text {
  margin: 0;
  font-size: 16px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 600;
  font-family: 'Inter', 'Kanit', 'Noto Sans', sans-serif;
  align-self: center;
  text-align: center;
  line-height: 1.1;
}

.user-actions {
  display: flex;
  align-items: center;
  gap: 20px;
}

.notification {
  position: relative;
  cursor: pointer;
}

.notification-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #e74c3c;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 12px;
}

.user-profile {
  position: relative;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #111827;
  color: #fff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
}

.caret {
  color: #6b7280;
  font-size: 12px;
}

.user-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  min-width: 220px;
  padding: 8px 0;
  border: 1px solid #e2e8f0;
  z-index: 1000;
  margin-top: 8px;
}

.menu-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #374151;
  font-weight: 500;
}

.menu-item:hover {
  background: #f3f4f6;
  color: #111827;
}

.menu-item.logout-item {
  color: #dc2626;
}

.menu-item.logout-item:hover {
  background: #fef2f2;
  color: #b91c1c;
}

.menu-icon {
  width: 20px;
  height: 20px;
  margin-right: 12px;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.menu-text {
  font-size: 14px;
  font-weight: 500;
}

.menu-divider {
  height: 1px;
  background: #e5e7eb;
  margin: 4px 0;
}

/* Navbar ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2 */
.navbar-bottom {
  background-color: #e74c3c;
  padding: 6px 0;
}

.navbar-bottom .navbar-container {
  max-width: none;
  padding: 0 12px;
}

.nav-list {
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
  width: 100%;
  justify-content: space-evenly;
}

.nav-list li {
  display: flex;
  justify-content: center;
  align-items: center;
}

.nav-link {
  color: white;
  text-decoration: none;
  font-weight: 500;
  text-align: center;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.nav-link:hover {
  background: rgba(255,255,255,0.15);
  transform: translateY(-1px);
}

.nav-link.active {
  background: rgba(255,255,255,0.25);
}

/* Main Content */
.user-main {
  flex: 1;
  padding: 0 20px 20px 20px;
  background-color: #f5f6fa;
}

/* Footer */
.user-footer {
  background-color: #e74c3c;
  color: white;
  padding: 30px 20px;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  gap: 60px;
  text-align: center;
}

.footer-section {
  flex: 1;
}

.footer-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 20px;
  color: white;
  font-family: 'Kanit', sans-serif;
}

.contact-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 16px;
  line-height: 1.5;
}

.contact-item i {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #ffd700;
}

.social-links {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

.social-link {
  display: flex;
  align-items: center;
  gap: 12px;
  color: white;
  text-decoration: none;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.social-link:hover {
  background-color: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

.social-link.facebook:hover {
  background-color: #1877f2;
  border-color: #1877f2;
}

.social-link i {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #ffd700;
}

.social-link.facebook i {
  color: #1877f2;
}

.social-link.facebook:hover i {
  color: white;
}

/* Responsive */
@media (max-width: 768px) {
  .user-menu {
    min-width: 200px;
  }
  
  .menu-item {
    padding: 10px 14px;
  }
  
  .menu-text {
    font-size: 13px;
  }
  
  .footer-content {
    flex-direction: column;
    gap: 30px;
  }
  
  .footer-title {
    font-size: 20px;
  }
  
  .contact-item,
  .social-link {
    font-size: 14px;
  }
}

/* Modal Styles */
.password-modal, .modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.modal-header h3 {
  margin: 0;
  color: #333;
  font-size: 20px;
}

.modal-close-btn, .close-btn {
  background: none;
  border: none;
  color: #666;
  font-size: 24px;
  cursor: pointer;
  padding: 5px;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
}

/* Password Form Styles */
.credentials-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.shop-info-header, .credentials-info, .password-section {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 4px;
}

.shop-info-header h4, .credentials-info h4, .password-section h4 {
  margin: 0 0 10px 0;
  color: #666;
  font-size: 16px;
}

.shop-name {
  margin: 0;
  color: #333;
  font-size: 18px;
  font-weight: 500;
}

.credential-item {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.credential-item:last-child {
  margin-bottom: 0;
}

.credential-item label {
  color: #666;
  font-weight: 500;
}

.credential-item span {
  color: #333;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  color: #666;
  font-weight: 500;
}

.form-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-group input.error {
  border-color: #dc3545;
}

.error-message {
  color: #dc3545;
  font-size: 12px;
  margin-top: 5px;
}

.password-requirements {
  margin: 15px 0;
  padding: 15px;
  background-color: white;
  border-radius: 4px;
  border: 1px solid #ddd;
}

.password-requirements p {
  margin: 0 0 10px 0;
  color: #666;
  font-weight: 500;
}

.password-requirements ul {
  margin: 0;
  padding: 0;
  list-style: none;
}

.password-requirements li {
  color: #666;
  margin-bottom: 5px;
  padding-left: 20px;
  position: relative;
}

.password-requirements li:before {
  content: '√ó';
  position: absolute;
  left: 0;
  color: #dc3545;
}

.password-requirements li.met {
  color: #28a745;
}

.password-requirements li.met:before {
  content: '‚úì';
  color: #28a745;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.cancel-btn, .save-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.cancel-btn {
  background-color: #f8f9fa;
  color: #666;
}

.save-btn {
  background-color: #28a745;
  color: white;
}

/* Password Input Wrapper */
.password-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.password-input-wrapper input {
  width: 100%;
  padding-right: 45px; /* Space for toggle button */
}

.password-toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
  padding: 5px;
  border-radius: 3px;
  transition: color 0.2s ease;
  z-index: 1;
}

.password-toggle-btn:hover {
  color: #333;
  background-color: #f8f9fa;
}

.password-toggle-btn:focus {
  outline: none;
  background-color: #e9ecef;
}

.password-toggle-btn i {
  font-size: 14px;
}

/* Current Password Wrapper */
.current-password-wrapper {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.current-password-toggle {
  position: static !important;
  transform: none !important;
  margin-left: 5px;
}

.save-btn:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

/* Details Modal Styles */
.shop-image-container {
  text-align: center;
  margin-bottom: 20px;
}

.shop-image {
  max-width: 200px;
  max-height: 200px;
  border-radius: 8px;
  object-fit: cover;
}

.shop-info {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.detail-item {
  display: grid;
  grid-template-columns: 150px 1fr;
  gap: 10px;
  align-items: center;
}

.detail-item label {
  color: #666;
  font-weight: 500;
}

.detail-item span {
  color: #333;
}

.detail-item span.expired {
  color: #dc3545;
}

/* Responsive Modal */
@media (max-width: 768px) {
  .modal-content {
    width: 95%;
  }

  .credential-item, .detail-item {
    grid-template-columns: 1fr;
    gap: 5px;
  }

  .form-actions {
    flex-direction: column;
  }

  .cancel-btn, .save-btn {
    width: 100%;
    justify-content: center;
  }
}
</style>
  